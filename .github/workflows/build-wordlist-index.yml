name: Build wordlist index

on:
  push:
    branches: [ "main", "master" ]
    paths:
      - "wordlist/**"
      - ".github/workflows/build-wordlist-index.yml"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate wordlists.json
        shell: bash
        run: |
          set -euo pipefail

          DIR="wordlist"
          OUT="wordlists.json"

          if [ ! -d "$DIR" ]; then
            echo "Folder '$DIR' not found. Aborting."
            exit 1
          fi

          # Create JSON
          node - <<'NODE'
          const fs = require("fs");
          const path = require("path");

          const dir = "wordlists";
          const out = "wordlists.json";

          const titleRegex = /const\s+wordlisttitle\s*=\s*["'`](.*?)["'`]\s*;?/i;

          function niceFromFilename(name){
            return name.replace(/\.(js|json|txt)$/i, "")
                       .replace(/[_-]+/g, " ")
                       .trim();
          }

          const files = fs.readdirSync(dir)
            .filter(f => /\.(js|json|txt)$/i.test(f))
            .sort((a,b) => a.localeCompare(b, "en"));

          const items = files.map(file => {
            const full = path.join(dir, file);
            const text = fs.readFileSync(full, "utf8");
            const m = text.match(titleRegex);
            const title = (m && m[1] && m[1].trim()) ? m[1].trim() : niceFromFilename(file);

            return {
              file,          // "buddhism.js"
              title,         // "Buddhism"
              updated: fs.statSync(full).mtime.toISOString()
            };
          });

          const payload = {
            generatedAt: new Date().toISOString(),
            count: items.length,
            items
          };

          fs.writeFileSync(out, JSON.stringify(payload, null, 2) + "\n");
          console.log(`Wrote ${out} with ${items.length} items.`);
          NODE

      - name: Commit changes (if any)
        shell: bash
        run: |
          set -euo pipefail
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add wordlists.json
          git commit -m "Update wordlists.json"
          git push
